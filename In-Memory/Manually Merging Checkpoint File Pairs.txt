Отключение автоматического слияние CFPs.
    
    DBCC TRACEON (9851, -1);
    
Включение автоматического слияние CFPs.

    DBCC TRACEOFF (9851, -1);

Принудительное слияния всех CFPs в определенном диапазоне транзакций:
    
    EXEC sys.sp_xtp_merge_checkpoint_files database_name, transaction_lower_bound, transaction_upper_bound;
    
    database_name
        Имя базы данных для выполнения операции слияния.
    transaction_lower_bound
        Нижний номер транзакции исходного CFP, который должен быть объединен.
    transaction_upper_bound
        Номер транзакции с верхним номером конечного CFP, который должен быть объединен.

Запуск сбора мусора:
    
    EXECUTE sp_xtp_checkpoint_force_garbage_collection;
    GO
    CHECKPOINT;
    GO
    
    CFP могут быть видны или не видны в представлении каталога sys.dm_db_xtp_checkpoint_files. Если они видны, они будут в какой-то момент удалены из представления. 
    
    Файлы на диске все еще видны, они проходят через отдельную сборку мусора. Необходимо выполнить следующие команды (как минимум дважды):
        
        BACKUP LOG database_name TO DISK = N'physical_device_name';
        GO
        EXECUTE sp_filestream_force_garbage_collection;
        GO
        
Когда CFPs объединяются и пространство освобождается, оно может занять до пяти операций контрольной точки (и последующих резервных копий журнала транзакций, если база данных не находится в простой модели восстановления), прежде чем пространство окончательно освободится:
    
    CHECKPOINT;
    GO
    BACKUP LOG database_name TO DISK = N'physical_device_name';
    GO

CFPs будут проходить через несколько состояний (см. Состояния CFPs.jpg):
    PRECREATED
        Когда в базе данных cоздается первая таблица оптимизировання для памяти, SQL Server генерирует CFPs. Эти файлы пустые, и они создаются для минимизации времени ожидания, когда gпотребуются новые файлы.
    UNDER CONSTRUCTION
        Когда необходим CFP, он переходит в состояние UNDER CONSTRUCTION, где могут быть сохранены вновь вставленные (и, возможно, удаленные) строки.
    ACTIVE
        Событие контрольной точки, выполняет несколько действий:
            - Сканирует оставшуюся (несканированную) часть журнала транзакций и сохраняет все оставшиеся записи журнала в CFPs.
            - Переводит все CFPs UNDER CONSTRACTION в состояние ACTIVE. На данный момент не допускаются вставки, однако строки все равно можно удалить.
            - Создает опись контрольной точки, в которой содержится информация обо всех файлах с предыдущей контрольной точки вместе с файлами, добавленными текущей контрольной точкой.
              Опись контрольной точки и глобальная метка транзакций (Global Transaction Timestamp) заносятся в журнал транзакций и доступны для SQL Server в процессе восстановления.
        
        В случае таблиц оптимизированных для памяти контрольная точка вызывается вручную с помощью команды CHECKPOINT или автоматически, когда журнал транзакций вырос со времени последней контрольной точки более чем на 512 МБ.
    MERGE TARGET
        Это первое состояние, в которое CFP будет переходить, когда участвует в операции слияния. CFP с состоянием MERGE TARGET будет содержать строки из консолидированных (объединенных) CFP.
        
        Фоновая задача, называемая оценщиком политики слияния (Merge Policy Evaluator) периодически анализирует, если смежные ACTIVE CFP можно объединить вместе так, чтобы активные, не удаленные строки из объединенных файлов данных вписывались в новый файл данных 16 МБ или 128 МБ.
        Когда это произойдет, SQL Server создает новый CFP в состоянии MERGE TARGET и заполняет его данными из нескольких ACTIVE CFP, отфильтровывая удаленные строки. Как только процесс слияния будет завершен, следующее событие контрольной точки переводит MERGE TARGET CFP в ACTIVE и прежние ACTIVE CFPs в состояния MERGED SOURCE.
    MERGE SOURCE
        Как только процесс слияния завершится, CFP, которые были источником слияния, перейдут в состояние MERGE SOURCE.
    REQUIRED FOR BACKUP/HA
        После следующего события контрольной точки CFRs MERGED SOURCE больше не нужны для восстановления базы данных. Для этой цели можно использовать бывшие MERGE TARGET и теперь ACTIVE CFP. 
        Тем не менее, эти CFP все еще необходимы, если вы хотите восстановить базу данных из резервной копии, поэтому они переключаются на состояние REQUIRED FOR BACKUP/HA.
        
        Как только точка усечения журнала перемещается за пределы диапазона транзакций CFP, ее можно пометить для сбора мусора.
        В модели восстановления FULL это означает, что была сделана резервная копия журнала, записи журнала были отправлены на вторичные узлы, а другие процессы, которые читают журнал транзакций, не отстали. 
        Очевидно, что в модели восстановления SIMPLE резервное копирование журнала не требуется, а точка отсечения журнала контролируется контрольно-пропускными пунктами.
    IN TRANSITION TO TOMBSTONE
        CFPs в этом состоянии больше не нужны движку In-Memory OLTP и просто ждут, когда фоновый поток переместит их в следующее состояние TOMBSTONE.
    TOMBSTONE
        CFPs в этом конечном состоянии ждут, когда процесс сбора мусора FILESTREAM удалит их.