Журнал транзакций может иметь несколько файлов, SQL Server работает с ним последовательно. 
Это означает, что все VLF в одном физическом файле используются до использования любых VLF во втором файле.

Если у вас есть хорошо управляемый журнал, который регулярно резервируется или усекается, 
вы никогда не сможете использовать файлы журнала транзакций, отличные от первого.

Если ни один из VLF в нескольких файлах физического журнала транзакций не доступен для повторного использования, 
SQL Server добавляет новые VLF в каждый физический файл журнала транзакций.

Если в томе, содержащем журнал транзакций, недостаточно свободного места, чтобы журнал мог расти достаточно, 
вам может потребоваться создать второй файл журнала на другом томе.

Внутренне SQL Server делит каждый физический файл журнала на более мелкие разделы, 
называемые файлами виртуальных журналов (VLF) (см. Transaction log and virtual log files.jpg).

SQL Server использует файлы виртуальных журналов в качестве единицы управления, 
они могут быть активными (active) или неактивными (inactive).

VLF активен, когда он хранит активную часть журнала транзакций, которая содержит поток журнальных записей, 
необходимых для обеспечения постоянной транзакции базы данных в случае откат транзакции или неожиданное завершение работы SQL Server. 

Неактивный VLF содержит усеченные (неактивные) и неиспользуемые части журнала транзакций.

Усечение журнала транзакций не уменьшает размер файла журнала на диске. 
Усечение означает, что части журнала транзакций (один или несколько VLF) отмечены как неактивные и готовы к повторному использованию.
Он очищает внутреннее пространство в журнале, сохраняя размер файла журнала.

Каждый раз, когда пользовательский поток вызывает диспетчер журналов (log manager), 
диспетчер журналов проверяет размер журнала.
Если размер превышает объем работы, который может быть восстановлен во время интервала восстановления (либо для сервера, либо для базы данных), 
просыпается поток контрольной точки. 
Поток проверяет базу данных и затем обрезает неактивную часть журнала.

Кроме того, если журнал когда-либо доходит до 70 процентов, когда база данных находится в режиме autotruncate, 
менеджер журналов пробуждает поток, чтобы активировать контрольную точку.
Рост журнала намного дороже, чем его усечение, поэтому SQL Server урезает журнал каждый раз, когда это возможно.

Определить, находится ли база данных в режиме autotruncate, можно с помощью представления sys.database_recovery_status. 
Если значение столбца last_log_backup_lsn равно NULL, база данных находится в режиме autotruncate.

Журнал транзакций является обходным файлом (см. A transaction log is a wraparound file.jpg).

SQL Server создает новые виртуальные файлы журналов каждый раз, когда журнал растет. 
Количество VLF зависит от вновь выделенного размера пространства и версии SQL Server. 

Размер распределения и количество созданных VLF (до SQL Server 2014):
    
    Размер распределения  Количество созданных VLF
    <64 МБ                4 VLFs
    64 МБ - 1 ГБ          8 VLFs
    > 1 ГБ                16 VLFs

В SQL Server 2014 и 2016 алгоритм немного изменился. 
Он анализирует текущий размер файла журнала, и если рост меньше 1/8 размера текущего журнала, он генерирует один файл VLF. 
В противном случае он использует старый алгоритм.

Можно просматривать виртуальные файлы журнала транзакций командой DBCC LOGINFO.
Первая физическая страница файла журнала содержит информацию заголовка, 
а не записи журнала, поэтому считается, что VLF начинается со второй страницы.

В столбце State указано, может ли VLF использоваться повторно:
    0 - означает, что он повторно используется или полностью не используется (полностью неиспользуемый VLF имеет значение FSeqNo равный 0);
    2 - означает, что он активен или восстанавливается.
    
Усечение или резервное копирование журнала транзакций изменяет восстанавливаемые VLF на повторно используемые VLF, 
поэтому статус 2 изменяет статус 0 для всех VLF, которые не включают активные записи журнала.

VLF со статусом 0 могут использоваться повторно для новых записей журнала, и журнал не должен расти.
С другой стороны, если все VLF в журнале имеют статус 2, 
SQL Server должен добавить новые VLF в журнал для записи новой транзакционной активности.

В столбце CreateLSN отображается текущее значение LSN во время добавления VLF в журнал транзакций.
Значение CreateLSN 0 означает, что VLF был частью исходного файла журнала, созданного при создании базы данных.
Вы также можете определить, сколько VLF было добавлено в одну операцию, заметив, какие VLF имеют одинаковое значение для CreateLSN.

Если у вас большие VLF, пространством журнала сложнее управлять, 
потому что у вас может быть только несколько активных записей журнала в VLF, 
но весь VLF будет считаться активным и никогда не будет использоваться повторно. 

Небольшие VLF упрощают управление размером журнала, но слишком много VLF вызывают дополнительные накладные расходы.

Для VLF нет идеального размера или идеального количества. 
Постарайтесь, чтобы ваши VLF были размером менее 1 ГБ.

Поэтому вместо создания журнала объемом 32 ГБ, который будет иметь 16 VLF по 2 ГБ каждый, 
вы можете создать его как файл размером 8 ГБ, а затем изменить его размер три раза, чтобы каждый раз добавлять по 8 ГБ.
Это дает вам 32 ГБ, но VLF 512 МБ каждый.

VLF может находиться в одном из четырех состояний:
    - Активный.
        Активная часть журнала начинается с минимального LSN, представляющего активную транзакцию. 
        Активная часть журнала заканчивается на последнем LSN. 
        Любые VLF, которые содержат любую часть активного журнала, считаются активными VLF.
    - Востонавливаемый.
        Часть журнала, предшествующая самой старой активной транзакции, 
        необходима только для поддержания последовательности резервных копий журнала для восстановления базы данных в прежнем состоянии.
    - Многоразовый
        Если резервные копии журнала транзакций не поддерживаются или вы уже создали резервную копию журнала, 
        VLF перед самой старой активной транзакцией не нужны и могут быть повторно использованы. 
        Усечение или резервное копирование журнала транзакций изменяет восстанавливаемые VLF на повторно используемые VLF.
    - Неиспользованный.
        Один или несколько VLF на физическом конце файлов журнала, возможно, еще не были использованы, 
        если не было проведено достаточно регистрируемой активности.
    
Для определения того, какие VLF являются многоразовыми, 
активные транзакции включают не только открытые транзакции.
 
Самая ранняя активная транзакция может быть транзакцией, отмеченной для репликации, которая еще не обработана, 
началом операции резервного копирования журнала или началом внутреннего диагностического сканирования, которое SQL Server выполняет периодически.

Если транзакции отмечены для репликации и еще не обрабатывались Log Reader, 
они считаются активными, как и транзакции, которые еще не были скопированы в зеркало или реплику базы данных.