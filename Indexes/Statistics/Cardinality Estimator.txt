Качество оптимизации запросов зависит от точных оценок мощности.
Необходимо правильно оценить количество строк на каждом этапе выполнения запроса, чтобы создать эффективный план выполнения.

В модели оценки мощности SQL Server 2005-2012 используются четыре основных допущения:
	Однородность (Uniformity)
		Эта модель предполагает равномерное распределение данных в отсутствие статистической информации.
		Например, при выполнении шагов внутри гистограммы предполагается, что все ключевые значения должны распределяться равномерно.

	Независимость (Independence)
		Эта модель предполагает, что атрибуты в сущности не зависят друг от друга. 
		Например, когда запрос имеет несколько предикатов для разных столбцов одной и той же таблицы, он предполагает, что столбцы никак не связаны.

	Простое ограничение (Simple Containment)
		Эта модель предполагает, что пользователи запрашивают данные, которые существуют в таблицах. 
		Например, когда вы присоединяетесь к двум таблицам, при отсутствии статистической информации модель предполагает, что все разные значения из одной таблицы существуют в другой. 
		Селективность оператора объединения в этой модели основана на селективности предикатов объединения.

	Включение (Inclusion)
		Эта модель предполагает, что когда атрибут сравнивается с константой, всегда есть совпадение.
		
В модели оценки мощности SQL Server 2014 и выше используются два основных допущения:
	Корреляция (Correlation)
		Корреляция между предикатами в запросах. 
		Это напоминает больше случаев в реальных запросах по сравнению с моделью допущения независимости.

	Базовое ограничение
		Эта модель предполагает, что пользователи могут запрашивать данные, которых нет в таблицах. 
		Он группирует гистограммы базовой таблицы в операции объединения в дополнение к избирательности предикатов соединения.
		
В SQL Server 2014 и выше можно выбрать модель оценки мощности на уровне базы данных, сервера, сеанса или запроса с использованием флагов трассировки.
Модели совместимости баз данных 120 и 130 соответствуют SQL Server 2014 и 2016 соответственно.
		
Можно увидеть версию модели оценки мощности, проанализировав свойство CardinalityEstimationModelVersion корневого элемента в плане выполнения.

Выбор модели оценщика мощности:
	 	
							<120 =120 =130
	Поведение по умолчанию  70   120  130
	T2312                   120  120  130
	T9481                   70   70   70

В SQL Server 2016 можно включить устаревшую оценку, используя инструкцию ALTER DATABASE SCOPED CONFIGURATION SET LEGACY_CARDINALITY_ESTIMATION = ON.

Выбор модели оценщика мощности в SQL Server 2016, когда LEGACY_CARDINALITY_ESTIMATION = ON:

							<120 =120 =130
	Поведение по умолчанию  70   70   70
	T2312                   120  120  130
	T9481                   70   70   70
	
Модель оценщика мощности 70 всегда ожидает, 
что функция (multi-statement table-valued function) вернет одну строку, как 120 и 130 вернут 100 строк.
Во многих случаях оценка 100 строк будет работать лучше, 
если функции (multi-statement table-valued functions) возвращают большой объем данных.

Сравнение оценочных показателей.    
    Актуальная статистика (см. https://www.safaribooksonline.com/library/view/pro-sql-server/9781484219645/A313962_2_En_3_Chapter.html#Sec7).
        Когда используется предикат для значения, 
        которое является ключом на одном из шагов гистограммы, SQL Server использует значение из столбца EQ_ROWS.
        
        Когда используется предикат для значения, 
        которое отсутствует в гистограмме в качестве ключа, SQL Server использует значение из столбца AVG_RANGE_ROWS.
        
        Когда используется локальная переменная в качестве предиката, 
        SQL Server использует среднюю селективность в индексе и оценивает количество строк, 
        умножая плотность ключа на общее количество строк в индексе.
        
        Когда статистика обновлена, все модели дают одинаковые результаты.        
    Устаревшая статистика (см. https://www.safaribooksonline.com/library/view/pro-sql-server/9781484219645/A313962_2_En_3_Chapter.html#Sec8).
        Когда используется предикат для значения, которое является ключом на одном из шагов гистограммы, 
        SQL сервер сравнивает количество строк в таблице с значением Rows Sampled в статистике и корректирует значение из EQ_ROWS столбца шага гистограммы соответственно.
         
        Когда используется предикат для значения, которое отсутствует в гистограмме в качестве ключа, 
        модель 70 использует значение AVG_RANGE_ROWS, 120 и 130 учитывают разницу в количестве строк, как и в предыдущем примере.
        
        Когда используется локальная переменная в качестве предиката, 
        новые модели корректируют оценку, основанную на различиях в подсчетах строк, а прежняя модель игнорирует их.
        
        Новые модели дают лучшие результаты, когда новые данные были равномерно распределены в индексе. 
        Альтернативно, устаревшая модель работает лучше в случаях неравномерного распределения новых значений, 
        когда распределение старых значений не изменилось.        
    Значение находится вне диапазона гистограммы (см. https://www.safaribooksonline.com/library/view/pro-sql-server/9781484219645/A313962_2_En_3_Chapter.html#Sec9).
        Модель 70 оценивает только одну строку, в то время как новые модели выполняют оценку, основанную на среднем распределении данных в индексе. 
        
        Новые модели обеспечивают лучшие результаты и позволяют избежать частого обновления статистики вручную для индексов с постоянно увеличивающимися значениями ключа.
        
    Соединения (см. https://www.safaribooksonline.com/library/view/pro-sql-server/9781484219645/A313962_2_En_3_Chapter.html#Sec10).
    
    Множественные предикаты (см. https://www.safaribooksonline.com/library/view/pro-sql-server/9781484219645/A313962_2_En_3_Chapter.html#Sec11).
        Новая модель оценки мощности исключает допущение незовисимости и ожидает некоторого уровня корреляции между атрибутами сущностей.
        
        Старая оценка мощности принимает независимость предикатов и использует следующую формулу:
            (Selectivity of first predicate * Selectivity of second predicate) * (Total number of rows in table) = (Estimated number of rows for first predicate * Estimated number of rows for second predicate) / (Total number of rows in the table)
            
        Новая оценка мощности рассчитывает некоторую корреляцию между предикатами и использует другой подход, называемый алгоритмом экспоненциального отклика, который выглядит следующим образом:
            (Selectivity of most selective predicate) * SQRT(Selectivity of next most selective predicate) * (Total number of rows in table)
            

Microsoft очень осторожно относилась к отправке исправлений и изменений в Query Optimizer (см. https://support.microsoft.com/en-us/help/974006/sql-server-query-optimizer-hotfix-trace-flag-4199-servicing-model).
По умолчанию они были отключены и должны были быть включены с использованием связанных с ними отдельных флагов трассировки.
Флаг трассировки T4199, сочетает в себе многие из этих исправлений, которые были рекомендованы в большинстве систем.

        TF4199  Before SQL Server 2016 RTM  After SQL Server 2016 RTM
<=120   OFF     Disabled                    Disabled
<=120   ON      Enabled                     Disabled
130     OFF     Enabled                     Disabled
130     ON      Enabled                     Enabled



